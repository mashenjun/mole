---
raw:
cooked:
# TiDB-Server panel Read & Write
  - record: tidb_p99_rt:total
    expr: 'histogram_quantile(0.99,sum(rate(tidb_server_handle_query_duration_seconds_bucket[1m]))by(le))'
  - record: tidb_p99_get_token_dur
    expr: 'histogram_quantile(0.99,sum(rate(tidb_server_get_token_duration_seconds_bucket[1m]))by(le))'
  - record: tidb_conn_cnt:by_instance
    expr: 'tidb_server_connections'
  - record: tidb_heap_size:by_instance
    expr: 'go_memstats_heap_inuse_bytes{job=~".*tidb"}'
# Parse panel Read & Write
  - record: tidb_p99_prase_dur:by_sql_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_session_parse_duration_seconds_bucket{sql_type!=""}[1m]))by(le,sql_type))>0'
# Compile panel Read & Write
  - record: tidb_p99_compile_dur:by_sql_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_session_compile_duration_seconds_bucket{sql_type!=""}[1m]))by(le,sql_type))>0'
# Transcation panel Read & Write
  - record: tidb_p99_txn_dur:by_sql_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_session_transaction_duration_seconds_bucket{sql_type!=""}[1m]))by(le,sql_type))>0'
  - record: tidb_p99_txn_stmt_cnt:by_sql_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_session_transaction_statement_num_bucket{sql_type!=""}[30s]))by(le,sql_type))>0'
  - record: tidb_p99_txn_retry_cnt
    expr: 'histogram_quantile(0.99,sum(rate(tidb_session_retry_num_bucket[30s]))by(le))>0'
# KV panel Read
  - record: tidb_p999_kv_cmd_rt:get:by_type
    expr: 'histogram_quantile(0.999,sum(rate(tidb_tikvclient_txn_cmd_duration_seconds_bucket{type=~"get|batch_get|seek|seek_reverse"}[1m]))by(le,type))>0'
  - record: tidb_p99_kv_cmd_rt:get:by_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_tikvclient_txn_cmd_duration_seconds_bucket{type=~"get|batch_get|seek|seek_reverse"}[1m]))by(le,type))>0'
  - record: tidb_lock_resolve_ops:by_type
    expr: 'sum(rate(tidb_tikvclient_lock_resolver_actions_total[1m]))by(type)'
  - record: tidb_p99_backoff_dur:by_type
    expr: 'histogram_quantile(0.99,sum(rate(tidb_tikvclient_backoff_seconds_bucket{type!=""}[5m]))by(le,type))>0'
  - record: tidb_backoff_ops:by_type
    expr: 'sum(rate(tidb_tikvclient_backoff_seconds_count[1m]))by(type)'
# PD Clinet panel Read & Write
  - record: pd_p999_cmd_wait_dur:tso
    expr: 'histogram_quantile(0.999,sum(rate(pd_client_cmd_handle_cmds_duration_seconds_bucket{type="tso"}[1m]))by(le))'
  - record: pd_p999_rpc_dur:tso
    expr: 'histogram_quantile(0.999,sum(rate(pd_client_request_handle_requests_duration_seconds_bucket{type="tso"}[1m]))by(le))'
# gRPC panel Read
  - record: tikv_p99_rt:read:by_type
    expr: 'histogram_quantile(0.99,sum(rate(tikv_grpc_msg_duration_seconds_bucket{type=~"kv_get|kv_batch_get|coprocessor"}[5m]))by(le,type))>0'
  - record: tikv_grpc_thd_cpu_usage:by_instance:by_name
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"grpc.*"}[1m]))by(instance,name)'
# Storage panel Read
  - record: tikv_readpool_thd_cpu_usage:by_instance
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"store_read.*"}[1m]))by(instance)'
# Coprocessor panel Read
  - record: tikv_p99_copr_wait_dur:by_req
    expr: 'histogram_quantile(0.99,sum(rate(tikv_coprocessor_request_wait_seconds_bucket{req!=""}[1m]))by(le,req))>0'
  - record: tikv_p99_copr_rt:by_req
    expr: 'histogram_quantile(0.99,sum(rate(tikv_coprocessor_request_handle_seconds_bucket{req!=""}[1m]))by(le,req))>0'
  - record: tikv_copr_thd_cpu_usage:by_instance
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"cop_.*"}[1m]))by(instance)'
# RocksDB-KV panel Read
  - record: tikv_avg_rocksdb_get_dur
    expr: 'max(tikv_engine_get_micro_seconds{db="kv",type="get_average"})'
  - record: tikv_p99_rocksdb_get_dur
    expr: 'max(tikv_engine_get_micro_seconds{db="kv",type="get_percentile99"})'
  - record: tikv_get_cache_hit:memtable_hit
    expr: 'sum(rate(tikv_engine_memtable_efficiency{db="kv",type="memtable_hit"}[1m]))'
  - record: tikv_get_cache_hit:block_cache
    expr: 'sum(rate(tikv_engine_cache_efficiency{db="kv",type=~"block_cache_data_hit|block_cache_filter_hit"}[1m]))'
  - record: tikv_get_served_ops:by_type
    expr: 'sum(rate(tikv_engine_get_served{db="kv",type=~"get_hit_l0|get_hit_l1|get_hit_l2_and_up"}[1m]))'
  - record: tikv_avg_rocksdb_seek_dur
    expr: 'max(tikv_engine_seek_micro_seconds{db="kv",type="seek_average"})'
  - record: tikv_p99_rocksdb_seek_dur
    expr: 'max(tikv_engine_seek_micro_seconds{db="kv",type="seek_percentile99"})'
  - record: tikv_seek_ops:by_type
    expr: 'sum(rate(tikv_engine_locate{db="kv",type=~"number_db_seek|number_db_seek_found|number_db_next|number_db_next_found|number_db_prev|number_db_prev_found"}[1m]))by(type)'
  - record: tikv_block_cache_hit_ratio:all
    expr: 'sum(rate(tikv_engine_cache_efficiency{type="block_cache_hit"}[1m]))/sum(rate(tikv_engine_cache_efficiency{type=~"block_cache_hit|block_cache_miss"}[1m]))'
  - record: tikv_block_cache_hit_ratio:data
    expr: 'sum(rate(tikv_engine_cache_efficiency{db="kv",type="block_cache_data_hit"}[1m]))/sum(rate(tikv_engine_cache_efficiency{db="kv",type=~"block_cache_data_hit|block_cache_data_miss"}[1m]))'
  - record: tikv_block_cache_hit_ratio:filter
    expr: 'sum(rate(tikv_engine_cache_efficiency{db="kv",type="block_cache_filter_hit"}[1m]))/sum(rate(tikv_engine_cache_efficiency{db="kv",type=~"block_cache_filter_hit|block_cache_filter_miss"}[1m]))'
  - record: tikv_block_cache_hit_ratio:index
    expr: 'sum(rate(tikv_engine_cache_efficiency{db="kv",type="block_cache_index_hit"}[1m]))/sum(rate(tikv_engine_cache_efficiency{db="kv",type=~"block_cache_index_hit|block_cache_index_miss"}[1m]))'
  - record: tikv_bloom_prefix_hit_ratio
    expr: 'sum(rate(tikv_engine_bloom_efficiency{db="kv",type="bloom_prefix_useful"}[1m]))/ sum(rate(tikv_engine_bloom_efficiency{db="kv",type="bloom_prefix_checked"}[1m]))'
# Disk panel Read & Write
  - record: node_disk_read_lat:by_instance:by_device
    expr: 'irate(node_disk_read_time_seconds_total[5m])/irate(node_disk_reads_completed_total[5m])'
  - record: node_disk_read_ops:by_instance:by_device
    expr: 'irate(node_disk_reads_completed_total[5m])'
  - record: node_disk_read_bw:by_instance:by_device
    expr: 'irate(node_disk_read_bytes_total[5m])'
  - record: node_disk_read_dur:by_instance:by_device
    expr: 'irate(node_disk_read_time_seconds_total[5m])'
# KV panel Write
  - record: tidb_p999_kv_cmd_rt:commit
    expr: 'histogram_quantile(0.999,sum(rate(tidb_tikvclient_txn_cmd_duration_seconds_bucket{type=~"commit"}[1m]))by(le,type))'
  - record: tidb_p99_kv_cmd_rt:commit
    expr: 'histogram_quantile(0.99,sum(rate(tidb_tikvclient_txn_cmd_duration_seconds_bucket{type=~"commit"}[1m]))by(le,type))'
# gRPC panel Write
  - record: tikv_p99_rt:write:by_type
    expr: 'histogram_quantile(0.99,sum(rate(tikv_grpc_msg_duration_seconds_bucket{type=~"kv_prewrite|kv_commit"}[5m]))by(le,type))>0'
# Scheduler panel Write
  - record: tikv_p95_sched_latch_wait_dur:by_type
    expr: 'histogram_quantile(0.95,sum(rate(tikv_scheduler_latch_wait_duration_seconds_bucket{type!=""}[5m]))by(le,type))>0'
  - record: tikv_avg_sched_latch_wait_dur:by_type
    expr: 'rate(tikv_scheduler_latch_wait_duration_seconds_sum[5m])/rate(tikv_scheduler_latch_wait_duration_seconds_count[5m])'
  - record: tikv_sched_thd_cpu_usage:by_instance
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"sched_.*"}[1m]))by(instance)'
  - record: tikv_p99_sched_cmd_dur:by_type
    expr: 'histogram_quantile(0.99,sum(rate(tikv_scheduler_command_duration_seconds_bucket{type!=""}[1m]))by(le,type))>0'
# raftstore panel Write
  - record: tikv_raftstore_req_wait_dur:by_instance
    expr: 'histogram_quantile(0.99,sum(rate(tikv_raftstore_request_wait_time_duration_secs_bucket[1m]))by(le,instance))'
  - record: tikv_raftstore_thd_cpu_usage:by_instance
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"raftstore_.*"}[1m]))by(instance)'
  - record: tikv_p99_raftstore_async_req_dur
    expr: 'histogram_quantile(0.99,sum(rate(tikv_storage_engine_async_request_duration_seconds_bucket{type="write"}[5m]))by(le))'
  - record: tikv_avg_raftstore_async_req_dur
    expr: 'sum(rate(tikv_storage_engine_async_request_duration_seconds_sum{type="write"}[5m]))/sum(rate(tikv_storage_engine_async_request_duration_seconds_count{type="write"}[5m]))'
# RocksDB-Raft Write
  - record: tikv_p99_raftstore_append_log_dur:by_instance
    expr: 'histogram_quantile(0.99,sum(rate(tikv_raftstore_append_log_duration_seconds_bucket[1m]))by(le,instance))'
  - record: tikv_p99_rocksdb_write_dur:raft
    expr: 'max(tikv_engine_write_micro_seconds{db="raft",type="write_percentile99"})'
  - record: tikv_avg_rocksdb_write_dur:raft
    expr: 'max(tikv_engine_write_micro_seconds{db="raft",type="write_average"})'
# RocksDB-KV Write
  - record: tikv_p99_raftstore_apply_wait_dur:by_instance
    expr: 'histogram_quantile(0.99,sum(rate(tikv_raftstore_apply_wait_time_duration_secs_bucket[5m]))by(le,instance))'
  - record: tikv_p99_raftstore_apply_log_dur
    expr: 'histogram_quantile(0.99,sum(rate(tikv_raftstore_apply_log_duration_seconds_bucket[1m]))by(le))'
  - record: tikv_avg_raftstore_apply_log_dur
    expr: 'sum(rate(tikv_raftstore_apply_log_duration_seconds_sum[1m]))/sum(rate(tikv_raftstore_apply_log_duration_seconds_count[1m]))'
  - record: tikv_p99_rocksdb_write_dur:kv
    expr: 'max(tikv_engine_write_micro_seconds{db="kv",type="write_percentile99"})'
  - record: tikv_avg_rocksdb_write_dur:kv
    expr: 'max(tikv_engine_write_micro_seconds{db="kv",type="write_average"})'
  - record: tikv_apply_thd_cpu_usage:by_instance
    expr: 'sum(rate(tikv_thread_cpu_seconds_total{name=~"apply_[0-9]+"}[1m]))by(instance)'
# Disk panel Write
  - record: node_disk_write_lat:by_instance:by_device
    expr: 'irate(node_disk_write_time_seconds_total[5m])/irate(node_disk_writes_completed_total[5m])'
  - record: node_disk_write_ops:by_instance:by_device
    expr: 'irate(node_disk_writes_completed_total[5m])'
  - record: node_disk_write_bw:by_instance:by_device
    expr: 'irate(node_disk_written_bytes_total[5m])'
  - record: node_disk_write_dur:by_instance:by_device
    expr: 'irate(node_disk_write_time_seconds_total[5m])'
